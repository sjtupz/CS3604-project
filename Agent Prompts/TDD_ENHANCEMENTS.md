# TDD 增强说明文档

## 概述

本文档说明了对 Agent Prompts 进行的 TDD（测试驱动开发）原则增强，确保所有 Agent 严格遵循 TDD 工作流程。

## TDD 核心原则

### RED-GREEN-REFACTOR 循环

1. **RED（红）阶段**：编写失败的测试
2. **GREEN（绿）阶段**：实现最小代码使测试通过
3. **REFACTOR（重构）阶段**：在测试通过的前提下优化代码

## 各 Agent 的 TDD 增强

### 1. test_generator.txt（测试生成器）

#### 增强内容：
- **明确 RED 阶段职责**：强调生成失败的测试用例是 TDD 的起点
- **测试独立性要求**：
  - 每个测试用例必须独立，不依赖执行顺序
  - 测试用例之间不能共享状态
  - 使用 `beforeEach` 和 `afterEach` 确保测试隔离
- **TDD 验证要求**：
  - 必须验证测试在当前代码骨架上会失败
  - 必须验证测试失败是因为缺少实现，而不是测试错误
  - 如果测试意外通过，需要移除代码骨架中的实现
- **测试结构要求**：
  - 遵循 AAA 模式（Arrange-Act-Assert）
  - 每个测试只验证一个行为
  - 测试应该像文档一样易读

#### 关键约束：
- **禁止**实现接口逻辑
- **禁止**在代码骨架中添加业务逻辑
- **禁止**修改测试用例使其通过
- **必须**确保所有测试在当前代码骨架上失败

### 2. frontend_developer.txt（前端开发工程师）

#### 增强内容：
- **RED 阶段验证**：
  - 必须首先运行测试，确认所有测试都失败
  - 如果测试意外通过，说明代码骨架有问题
- **GREEN 阶段约束**：
  - 只实现使测试通过的最小代码量
  - 一次只修复一个失败的测试用例
  - 禁止添加额外功能
  - 禁止优化或重构（优化在 REFACTOR 阶段进行）
- **RED-GREEN 循环**：
  - 选择最简单的失败测试
  - 实现最小代码使其通过
  - 立即运行测试验证
  - 重复直到所有测试通过
- **REFACTOR 阶段**：
  - 前提：所有测试必须通过
  - 重构后必须立即运行所有测试
  - 如果测试失败，立即回退重构
  - 禁止在重构时添加新功能

#### 关键约束：
- **禁止**在没有测试的情况下编写代码
- **禁止**跳过失败的测试继续开发
- **禁止**在测试失败时修改测试用例
- **禁止**在重构阶段添加新功能
- **必须**频繁运行测试，每次代码修改后立即验证

### 3. backend_developer.txt（后端开发工程师）

#### 增强内容：
- **RED 阶段验证**：与前端开发工程师相同
- **GREEN 阶段约束**：与前端开发工程师相同
- **数据库操作 TDD 约束**：
  - 只实现测试用例要求的数据库操作
  - 每个数据库操作必须有对应的测试用例
  - 测试必须使用独立的数据库连接或事务
  - 使用 `beforeEach` 和 `afterEach` 设置和清理测试数据
- **数据库测试隔离**：
  - 每个测试用例必须使用独立的测试数据库
  - 确保测试之间完全隔离，不共享数据库状态
- **REFACTOR 阶段**：
  - 数据库结构变更必须通过迁移脚本
  - 确保迁移脚本有对应的测试用例
  - 确保重构后的数据库操作与测试用例兼容

#### 关键约束：
- 与前端开发工程师相同的约束
- **额外约束**：
  - 禁止在测试之间共享数据库状态
  - 确保每个测试使用独立的数据库连接

## TDD 工作流程

### 完整流程：

```
1. test_generator（RED阶段）
   ├── 生成代码骨架（最小化，非功能性）
   ├── 生成失败的测试用例
   └── 验证所有测试失败

2. frontend_developer / backend_developer（GREEN阶段）
   ├── 验证所有测试失败（RED状态）
   ├── 选择一个失败的测试
   ├── 实现最小代码使测试通过
   ├── 运行测试验证
   └── 重复直到所有测试通过

3. frontend_developer / backend_developer（REFACTOR阶段）
   ├── 确认所有测试通过
   ├── 重构代码（行为保持）
   ├── 运行所有测试验证
   └── 如果测试失败，回退重构
```

## TDD 核心约束总结

### 所有 Agent 必须遵守：

1. **测试用例神圣性**：绝对不要修改测试用例，只修改实现代码
2. **测试通过要求**：测试通过是完成开发的唯一标准
3. **增量开发**：一次只实现一个功能点
4. **快速反馈**：频繁运行测试，每次代码修改后立即验证
5. **测试隔离**：每个测试必须独立，不依赖其他测试

### 严格禁止：

1. ❌ 在没有测试的情况下编写代码
2. ❌ 跳过失败的测试继续开发
3. ❌ 在测试失败时修改测试用例使其通过
4. ❌ 在重构阶段添加新功能
5. ❌ 一次修复多个测试用例（除非测试同一个功能点）
6. ❌ 在 GREEN 阶段进行优化或重构
7. ❌ 在测试之间共享状态（前端）或数据库状态（后端）

## 预期效果

通过这些 TDD 增强，预期达到以下效果：

1. **更严格的 TDD 流程**：确保每个阶段都严格按照 TDD 原则执行
2. **更好的测试覆盖**：确保所有需求都有对应的测试用例
3. **更高的代码质量**：通过测试驱动，确保代码符合需求
4. **更安全的重构**：通过测试保护，确保重构不会破坏功能
5. **更快的反馈**：频繁运行测试，快速发现问题

## 使用建议

1. **按顺序执行**：严格按照 test_generator → developer 的顺序执行
2. **验证每个阶段**：在每个阶段完成后验证是否符合 TDD 要求
3. **保持测试运行**：始终保持测试处于可运行状态
4. **遵循约束**：严格遵守所有 TDD 约束和禁止事项

