# 后端 API 测试覆盖率报告

## 1. 概述

本报告旨在分析 `GET /api/v1/tickets` 接口的现有自动化测试 (`ticket.routes.spec.ts`) 对需求文档 `04_车次列表页.md` 中定义的功能点的覆盖情况。旨在明确当前已验证的功能范围，并识别尚未被测试或实现的功能差距，为后续的开发和测试工作提供指引。

---

## 2. 已覆盖的需求点

当前的 API 测试套件已成功验证了以下核心功能和场景：

| 需求点 | 需求文档章节 | 描述 | 覆盖的测试用例 |
| :--- | :--- | :--- | :--- |
| **核心查询功能** | `3.1.3.2`, `3.3.1` | 验证了基于 **出发地、目的地、出发日** 三个基本参数的有效查询能成功返回车次列表。 | `should return 200 OK with a list of tickets for a valid query` |
| **车次类型过滤** | `3.1.3.2` | 验证了 API 能够根据传入的 `trainTypes` 参数（如 "G", "D"）对车次类型进行正确筛选。 | `should return only G and D type trains when trainTypes=G,D` |
| **按余票情况过滤** | `3.1.5.5` | 通过 `onlyShowAvailable` 参数，验证了 API 能筛选出有票或所有车次（包括无票）的逻辑。 | `should return an empty list if onlyShowAvailable is true and no tickets have stock` |
| **输入验证** | `3.3.1` | 验证了当缺少必要参数（如 `date`）或参数格式错误时，API 能返回 `400 Bad Request`。 | `should return 400 Bad Request if date is missing`, `should return 400 Bad Request for invalid date format` |
| **排序功能** | (隐含需求) | 验证了 API 支持按 `sortBy` 参数进行排序（以 `durationAsc` 为例）。 | `should call the service with sortBy=durationAsc` |
| **API 健壮性** | (通用质量要求) | 验证了当服务端发生意外（如数据库连接丢失）时，API 能返回 `500 Internal Server Error`。 | `should return 500 Internal Server Error and silence console.error` |
| **性能优化：缓存** | (非功能性需求) | 验证了 API 具备缓存能力，连续的相同请求会命中缓存，提升响应速度。 | `should hit the cache on the second identical request` |

---

## 3. 未覆盖的需求点 (功能差距)

以下是需求文档中提到，但当前后端 API 和测试用例尚未覆盖的功能点：

| 功能差距 | 需求文档章节 | 描述与分析 |
| :--- | :--- | :--- |
| **高级过滤：按具体车站** | `3.1.3.3`, `3.1.3.4` | **差距**：API 目前仅支持按城市（如 "BEIJING"）查询，不支持按城市下的具体车站（如 "北京南", "北京丰台"）进行过滤。 |
| **高级过滤：按席别** | `3.1.3.5` | **差距**：API 缺少按 "一等座"、"二等座" 等席别进行过滤的参数和逻辑。 |
| **高级过滤：按发车时段** | `3.1.3.6` | **差距**：API 缺少按 "0:00-6:00" 等发车时间范围进行过滤的参数和逻辑。 |
| **核心业务：复杂余票计算** | `3.4.2` | **重大差距**：当前数据模型将库存 (`stock`) 存储为单个整数，而需求要求 **以座位为单位，按站点分段计算余票**。这是一个根本性的数据结构和逻辑差异。当前的实现无法支持中途上下车场景的精确余票统计。 |
| **核心业务：复杂票价计算** | `3.4.3` | **重大差距**：需求规定票价应为 **途经各站票价之和**。当前实现仅从数据库读取一个固定的总价，未实现分段计价逻辑。 |
| **核心业务：预定与数据库更新** | `3.1.5.6`, `3.4.4` | **差距**：所有测试均针对车票 **查询 (`GET`)**。**预定 (`POST/PUT`)** 操作及其导致的数据库座位状态更新（从"空闲"到"已被预定"）完全没有被实现和测试。 |

---

## 4. 总结与建议

**总结：**
当前的后端 API 成功实现并测试了车票的 **基本查询和初步筛选** 功能，并具备了良好的健壮性和性能（缓存）。

然而，与需求文档相比，在 **高级过滤功能** 和 **核心业务逻辑（如分段余票/计价）** 方面存在显著差距。目前的实现是一个简化版本，而非文档所描述的完整、精确的铁路票务系统。

**建议后续步骤：**

1.  **扩展 API 功能**：为 `GET /api/v1/tickets` 接口添加对 **具体车站、席别、发车时段** 的过滤参数。
2.  **重构数据模型**：优先重新设计数据库 Schema，以支持按座位、按站点的状态跟踪，这是实现精确余票和计价功能的前提。
3.  **实现核心业务逻辑**：基于新的数据模型，开发分段式的余票和票价计算服务。
4.  **开发预定功能**：创建新的 API 端点（如 `POST /api/v1/orders`）来处理车票预定，并实现更新数据库状态的逻辑。
5.  **补充测试用例**：为上述所有新功能编写对应的单元测试和集成测试，确保功能的正确性和稳定性。