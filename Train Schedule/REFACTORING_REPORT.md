# 后端代码重构报告

## 1. 概述

本次重构旨在优化后端代码的 **结构、性能、安全性和可维护性**，同时确保 **100% 的功能兼容性** 和 **测试通过率**。重构严格遵循 "Clean Code" 原则，未改变任何外部 API 行为。

---

## 2. 代码结构优化 (Structure & DRY)

核心目标是实现 **“瘦 Controller，厚 Service”** 的设计，并提升代码的模块化和复用性。

### 2.1. 提取查询构建器 (`query-builder.ts`)

- **变更**: 将原先堆积在 `TicketService` 中的动态 SQL 查询逻辑（`WHERE` 和 `ORDER BY` 子句的构建）提取到了一个独立的工具模块 `src/utils/query-builder.ts` 中。
- **影响**:
    - **职责分离**: `TicketService` 现在专注于业务流程（缓存、数据转换、分页），而 `query-builder` 专注于 SQL 构建。职责更加清晰。
    - **可复用性**: `buildTicketQuery` 成为一个纯函数，未来可被其他需要类似查询逻辑的服务复用。
    - **可测试性**: 独立的查询构建逻辑更易于进行单元测试。

### 2.2. 瘦身服务层 (`ticket.service.ts`)

- **变更**: `TicketService` 的 `searchAndFilter` 方法现在调用 `buildTicketQuery` 来获取查询语句，自身不再处理复杂的条件判断。
- **影响**: `searchAndFilter` 方法的行数减少，逻辑更清晰，更容易理解和维护。

---

## 3. 查询性能优化 (Performance)

### 3.1. 添加数据库索引

- **变更**: 在 `seed_tickets.sql` 中，为 `temp_ticket_data` 表添加了一个复合索引 `idx_ticket_search`，覆盖了最高频的查询字段：`from_station`, `to_station`, `departure_date`。
    ```sql
    CREATE INDEX idx_ticket_search ON temp_ticket_data (from_station, to_station, departure_date);
    ```
- **性能影响分析**:
    - **之前**: 对这三个字段的查询会导致数据库进行 **全表扫描 (Full Table Scan)**，查询时间复杂度为 O(N)，其中 N 是表中的总行数。
    - **之后**: 查询引擎可以直接利用索引进行 **索引查找 (Index Seek)**，时间复杂度近似 O(log N)。对于大数据量的表，查询速度将有 **数量级** 的提升。

### 3.2. 实现查询结果缓存

- **变更**: 在 `TicketService` 中引入了 `lru-cache`，实现了一个内存缓存 (In-Memory LRU Cache)。
    - 缓存容量: 100 条最近的查询结果。
    - 缓存有效期 (TTL): 5 分钟。
- **性能影响分析**:
    - **首次查询 (Cache Miss)**: 流程与之前相同，执行数据库查询，然后将结果存入缓存。
    - **后续相同查询 (Cache Hit)**: 在 5 分钟内，任何完全相同的查询请求将 **直接从内存中获取数据**，完全绕过数据库。响应时间将从几十到几百毫秒（数据库查询）降低到 **几毫秒以内**（内存读取）。
    - **实践验证**: 新增的缓存单元测试 (`ticket.routes.spec.ts`) 验证了此行为，第二次请求的日志中明确打印了 `[Cache HIT]`。

---

## 4. 安全性加固 (Security)

- **审查**: 对所有数据库查询代码进行了审查。
- **结论**: 项目 **100% 使用了参数化查询** (`better-sqlite3` 的 `prepare` 方法)。`query-builder.ts` 只负责拼接 SQL 的结构部分，所有用户输入的值都作为参数传递给 `db.prepare(...).get(...)` 或 `db.prepare(...).all(...)`。
- **影响**: 有效地防止了 **SQL 注入** 攻击。

---

## 5. 质量保证 (Quality Assurance)

### 5.1. 测试用例增强

- **新增测试**: 在 `src/routes/__tests__/ticket.routes.spec.ts` 中添加了以下测试：
    1.  **缓存命中测试**: 验证连续的相同请求是否能命中缓存。
    2.  **错误日志静音**: 在测试预期的 500 错误时，通过 `jest.spyOn(console, 'error')` 静音了控制台错误输出，使测试报告更整洁。

### 5.2. 测试覆盖率报告

通过运行 `npm test -- --coverage` 生成了测试覆盖率报告。以下是核心组件的覆盖率摘要：

```
-------------------------|---------|----------|---------|---------|-------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------------|---------|----------|---------|---------|-------------------
All files                |   85.07 |    76.92 |   77.77 |   85.07 |                   
 app.ts                  |     100 |      100 |     100 |     100 |                   
 services/ticket.service.ts |   81.25 |       75 |      50 |   81.25 | 28,111-113        
 utils/query-builder.ts  |     100 |       75 |     100 |     100 | 25                
-------------------------|---------|----------|---------|---------|-------------------
```

- **分析**:
    - **`app.ts`**: 100% 覆盖，表明所有路由和中间件都已在测试中被触及。
    - **`utils/query-builder.ts`**: 语句和函数覆盖率达到 100%，分支覆盖率为 75%。未覆盖的分支是 `sortBy` 中的 `default` 情况，这是一个低风险的边缘情况。
    - **`services/ticket.service.ts`**: 语句覆盖率为 81.25%。未覆盖的行主要与数据转换的细节有关，这些细节在当前的集成测试中没有被完全覆盖，但核心的查询、缓存和分页逻辑已得到验证。

- **结论**: 核心业务逻辑和重构引入的新模块（`query-builder`）具有很高的测试覆盖率，保证了代码的质量和稳定性。